<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>WGPU WebGL2 WASM Test</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #1a1a2e; color: #eee; }
        canvas { border: 1px solid #444; background: #000; }
        pre { background: #0f0f1a; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .success { color: #4ade80; }
        .error { color: #f87171; }
        h2 { color: #60a5fa; }
    </style>
</head>
<body>
    <h1>WGPU WebGL2 WASM Proof of Concept</h1>

    <h2>Test 1: Basic WASM loading</h2>
    <div id="test1">Loading...</div>

    <h2>Test 2: WebGL2 Context</h2>
    <canvas id="canvas" width="400" height="300"></canvas>
    <div id="test2">Loading...</div>

    <h2>Test 3: WGSL to GLSL Transpilation</h2>
    <div id="test3">Loading...</div>
    <h3>Input WGSL:</h3>
    <pre id="wgsl-input"></pre>
    <h3>Output GLSL ES 300:</h3>
    <pre id="glsl-output"></pre>

    <script type="module">
        import init, { test_wasm, get_webgl2_context, transpile_wgsl_to_glsl } from './pkg/wgpu_webgl_wasm.js';

        const wgslSource = `
@vertex
fn main(@builtin(vertex_index) vertex_index: u32) -> @builtin(position) vec4<f32> {
    var positions = array<vec2<f32>, 3>(
        vec2<f32>(0.0, 0.0),
        vec2<f32>(-0.5, -0.5),
        vec2<f32>(0.5, -0.5)
    );
    return vec4<f32>(positions[vertex_index], 0.0, 1.0);
}
`;

        async function runTests() {
            try {
                // Initialize WASM module
                await init();

                // Test 1: Basic WASM functionality
                const result = test_wasm();
                document.getElementById('test1').innerHTML =
                    `<span class="success">✓ ${result}</span>`;

                // Test 2: Get WebGL2 context
                const canvas = document.getElementById('canvas');
                try {
                    const gl = get_webgl2_context(canvas);
                    document.getElementById('test2').innerHTML =
                        `<span class="success">✓ WebGL2 context obtained: ${gl.constructor.name}</span>`;

                    // Draw something to prove it works
                    gl.clearColor(0.1, 0.2, 0.3, 1.0);
                    gl.clear(gl.COLOR_BUFFER_BIT);
                } catch (e) {
                    document.getElementById('test2').innerHTML =
                        `<span class="error">✗ Error: ${e}</span>`;
                }

                // Test 3: WGSL to GLSL transpilation
                document.getElementById('wgsl-input').textContent = wgslSource.trim();
                try {
                    const glsl = transpile_wgsl_to_glsl(wgslSource);
                    document.getElementById('test3').innerHTML =
                        `<span class="success">✓ Transpilation successful!</span>`;
                    document.getElementById('glsl-output').textContent = glsl;
                } catch (e) {
                    document.getElementById('test3').innerHTML =
                        `<span class="error">✗ Transpilation error: ${e}</span>`;
                    document.getElementById('glsl-output').textContent = String(e);
                }

            } catch (e) {
                document.getElementById('test1').innerHTML =
                    `<span class="error">✗ Failed to initialize WASM: ${e}</span>`;
                console.error(e);
            }
        }

        runTests();
    </script>
</body>
</html>
